{% extends 'base.html' %}

{% block header %}{% endblock %}

{% block content %}
<div class="joke-container">
  <div class="page-header">
    {% if g.user %}
      <a class="btn-new-joke" href="{{ url_for('jokes.leave') }}">+ New Joke</a>
    {% endif %}
  </div>

  {% if jokes %}
    <div class="jokes-list">
    {% for joke in jokes %}
      <div class="joke-card" id="joke-{{ joke['id'] }}" data-avg-rating="{{ joke['avg_rating'] }}" data-created="{{ joke['created'].isoformat() }}">
        <div class="joke-header">
          <div>
            <h2 class="joke-title">{{ joke['title'] }}</h2>
            <div class="joke-meta">
              <span>Posted by <a href="{{ url_for('auth.profile', username=joke['username']) }}" class="joke-author">@{{ joke['username'] }}</a></span>
              <span>‚Ä¢</span>
              <span>{{ joke['created'].strftime('%B %d, %Y') }}</span>
            </div>
          </div>
          {% if g.user and g.user['id'] == joke['author_id'] %}
            <div class="joke-actions">
              <a class="btn-edit" href="{{ url_for('jokes.update', id=joke['id']) }}">‚úèÔ∏è Edit</a>
            </div>
          {% endif %}
        </div>
        <p class="joke-body">{{ joke['body'] }}</p>
        
        <!-- Star Rating Section -->
        <div class="rating-container">
          {% if g.user %}
            <div class="star-rating" data-joke-id="{{ joke['id'] }}">
              {% for i in range(1, 6) %}
                <span class="star {% if user_ratings.get(joke['id']) and user_ratings[joke['id']] >= i %}filled user-rated{% elif joke['avg_rating'] >= i %}filled{% endif %}" 
                      data-rating="{{ i }}">‚òÖ</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="star-rating">
              {% for i in range(1, 6) %}
                <span class="star {% if joke['avg_rating'] >= i %}filled{% endif %}">‚òÖ</span>
              {% endfor %}
            </div>
          {% endif %}
          
          <div class="rating-info">
            <span class="avg-rating">{{ "%.1f"|format(joke['avg_rating']) }}</span>
            <span class="rating-count">({{ joke['rating_count'] }} rating{{ 's' if joke['rating_count'] != 1 else '' }})</span>
          </div>
        </div>
        
        <!-- Comments Section -->
        <div class="comments-section">
          <h3 class="comments-title">
            üí¨ Comments ({{ comments[joke['id']]|length }})
          </h3>
          
          <div class="comments-list" id="comments-{{ joke['id'] }}">
            {% for comment in comments[joke['id']] %}
              <div class="comment" data-comment-id="{{ comment['id'] }}">
                <div class="comment-header">
                  <span class="comment-author">@{{ comment['nickname'] }}</span>
                  <span class="comment-date">{{ comment['created'].strftime('%b %d, %Y at %I:%M %p') }}</span>
                  {% if g.user and g.user['id'] == comment['user_id'] %}
                    <button class="btn-delete-comment" onclick="deleteComment({{ comment['id'] }}, {{ joke['id'] }})">üóëÔ∏è</button>
                  {% endif %}
                </div>
                <p class="comment-body">{{ comment['body'] }}</p>
              </div>
            {% endfor %}
          </div>
          
          {% if g.user %}
            <button class="btn-show-comment-form" onclick="toggleCommentForm({{ joke['id'] }})">
              üí¨ Leave a Comment
            </button>
            <form class="comment-form" id="comment-form-{{ joke['id'] }}" style="display: none;" onsubmit="addComment(event, {{ joke['id'] }})">
              <textarea 
                class="comment-input" 
                name="body" 
                placeholder="Add a comment... (max 500 characters)" 
                maxlength="500"
                rows="2"
                required></textarea>
              <div class="comment-form-footer">
                <span class="comment-char-count" data-joke-id="{{ joke['id'] }}">0/500</span>
                <button type="submit" class="btn-comment">Post Comment</button>
                <button type="button" class="btn-cancel-comment" onclick="toggleCommentForm({{ joke['id'] }})">Cancel</button>
              </div>
            </form>
          {% else %}
            <p class="comment-login-prompt">
              <a href="{{ url_for('auth.login') }}">Log in</a> to leave a comment
            </p>
          {% endif %}
        </div>
      </div>
    {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üò¢</div>
      <p class="empty-state-text">No jokes yet!</p>
      <p>Be the first to share a joke and make everyone laugh!</p>
      {% if g.user %}
        <a href="{{ url_for('jokes.leave') }}" class="btn-primary" style="margin-top: 1rem; display: inline-block;">Share Your First Joke</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}" class="btn-primary" style="margin-top: 1rem; display: inline-block;">Login to Share Jokes</a>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
function rateJoke(jokeId, rating) {
  fetch(`/${jokeId}/rate`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `rating=${rating}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the stars
      const jokeCard = document.querySelector(`.star-rating[data-joke-id="${jokeId}"]`).closest('.joke-card');
      const starContainer = jokeCard.querySelector(`.star-rating[data-joke-id="${jokeId}"]`);
      const stars = starContainer.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.remove('filled', 'user-rated');
        if (index < rating) {
          star.classList.add('filled', 'user-rated');
        }
      });
      
      // Update rating info
      const ratingInfo = starContainer.nextElementSibling;
      ratingInfo.querySelector('.avg-rating').textContent = data.avg_rating.toFixed(1);
      ratingInfo.querySelector('.rating-count').textContent = 
        `(${data.rating_count} rating${data.rating_count !== 1 ? 's' : ''})`;
      
      // Store the new average rating in the card for sorting
      jokeCard.dataset.avgRating = data.avg_rating;
      
      // Show success message
      showMessage('Rating saved! ‚≠ê');
      
      // Reorder jokes after a brief delay to show the update
      setTimeout(() => reorderJokes(), 500);
    } else {
      showMessage('Error saving rating', true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showMessage('Error saving rating', true);
  });
}

function reorderJokes() {
  const jokesContainer = document.querySelector('.jokes-list');
  if (!jokesContainer) return;
  
  const jokeCards = Array.from(jokesContainer.querySelectorAll('.joke-card'));
  
  // Sort by average rating (highest first), then by creation date
  jokeCards.sort((a, b) => {
    const ratingA = parseFloat(a.dataset.avgRating || 0);
    const ratingB = parseFloat(b.dataset.avgRating || 0);
    
    if (ratingB !== ratingA) {
      return ratingB - ratingA; // Higher rating first
    }
    
    // If ratings are equal, sort by created date (newer first)
    const dateA = new Date(a.dataset.created);
    const dateB = new Date(b.dataset.created);
    return dateB - dateA;
  });
  
  // Add fade out effect
  jokeCards.forEach(card => {
    card.style.opacity = '0.3';
    card.style.transform = card.style.transform + ' scale(0.95)';
  });
  
  // Re-append in new order after brief delay
  setTimeout(() => {
    jokeCards.forEach(card => jokesContainer.appendChild(card));
    
    // Fade back in with cascading effect
    setTimeout(() => {
      jokeCards.forEach(card => {
        card.style.opacity = '';
        card.style.transform = '';
      });
    }, 100);
  }, 300);
}

// Toggle Comment Form
function toggleCommentForm(jokeId) {
  const button = document.querySelector(`.btn-show-comment-form[onclick*="${jokeId}"]`);
  const form = document.getElementById(`comment-form-${jokeId}`);
  
  if (form.style.display === 'none' || !form.style.display) {
    form.style.display = 'block';
    button.style.display = 'none';
    // Focus on the textarea
    form.querySelector('textarea').focus();
  } else {
    form.style.display = 'none';
    button.style.display = 'block';
    // Clear the form
    form.querySelector('textarea').value = '';
    form.querySelector('.comment-char-count').textContent = '0/500';
  }
}

// Comment Functions
async function addComment(event, jokeId) {
  event.preventDefault();
  const form = event.target;
  const textarea = form.querySelector('textarea[name="body"]');
  const body = textarea.value.trim();
  
  if (!body) {
    showMessage('Comment cannot be empty', true);
    return;
  }
  
  try {
    const response = await fetch(`/${jokeId}/comment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `body=${encodeURIComponent(body)}`
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Add comment to the list
      const commentsList = document.getElementById(`comments-${jokeId}`);
      const commentHtml = `
        <div class="comment" data-comment-id="${data.comment.id}">
          <div class="comment-header">
            <span class="comment-author">@${data.comment.nickname}</span>
            <span class="comment-date">Just now</span>
            ${data.comment.is_owner ? `<button class="btn-delete-comment" onclick="deleteComment(${data.comment.id}, ${jokeId})">üóëÔ∏è</button>` : ''}
          </div>
          <p class="comment-body">${escapeHtml(data.comment.body)}</p>
        </div>
      `;
      commentsList.insertAdjacentHTML('beforeend', commentHtml);
      
      // Update comment count
      const titleEl = commentsList.previousElementSibling;
      const countMatch = titleEl.textContent.match(/\((\d+)\)/);
      if (countMatch) {
        const newCount = parseInt(countMatch[1]) + 1;
        titleEl.textContent = `üí¨ Comments (${newCount})`;
      }
      
      // Clear form and hide it
      textarea.value = '';
      form.querySelector('.comment-char-count').textContent = '0/500';
      toggleCommentForm(jokeId);
      
      showMessage(data.message);
    } else {
      showMessage(data.message || 'Failed to add comment', true);
    }
  } catch (error) {
    console.error('Error adding comment:', error);
    showMessage('An error occurred while adding comment', true);
  }
}

async function deleteComment(commentId, jokeId) {
  if (!confirm('Are you sure you want to delete this comment?')) {
    return;
  }
  
  try {
    const response = await fetch(`/comment/${commentId}/delete`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Remove comment from DOM
      const commentEl = document.querySelector(`[data-comment-id="${commentId}"]`);
      if (commentEl) {
        commentEl.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => commentEl.remove(), 300);
      }
      
      // Update comment count
      const commentsList = document.getElementById(`comments-${jokeId}`);
      const titleEl = commentsList.previousElementSibling;
      const countMatch = titleEl.textContent.match(/\((\d+)\)/);
      if (countMatch) {
        const newCount = Math.max(0, parseInt(countMatch[1]) - 1);
        titleEl.textContent = `üí¨ Comments (${newCount})`;
      }
      
      showMessage(data.message);
    } else {
      showMessage(data.message || 'Failed to delete comment', true);
    }
  } catch (error) {
    console.error('Error deleting comment:', error);
    showMessage('An error occurred while deleting comment', true);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showMessage(text, isError = false) {
  const message = document.createElement('div');
  message.className = 'rating-message';
  message.textContent = text;
  if (isError) {
    message.style.background = 'linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%)';
    message.style.color = '#d63031';
  }
  document.body.appendChild(message);
  
  setTimeout(() => {
    message.style.animation = 'slideInRight 0.3s ease-out reverse';
    setTimeout(() => message.remove(), 300);
  }, 2000);
}

// Add hover effect and click handlers for stars
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.star-rating[data-joke-id]').forEach(container => {
    const jokeId = container.getAttribute('data-joke-id');
    const stars = container.querySelectorAll('.star');
    
    stars.forEach((star, index) => {
      const rating = parseInt(star.getAttribute('data-rating'));
      
      // Add click handler
      star.addEventListener('click', function() {
        console.log(`Clicking star ${rating} for joke ${jokeId}`);
        rateJoke(jokeId, rating);
      });
      
      // Add hover effect
      star.addEventListener('mouseenter', function() {
        stars.forEach((s, i) => {
          if (i <= index) {
            s.classList.add('hovered');
          } else {
            s.classList.remove('hovered');
          }
        });
      });
    });
    
    container.addEventListener('mouseleave', function() {
      stars.forEach(s => s.classList.remove('hovered'));
    });
  });
  
  // Update card z-index based on scroll position
  updateCardStacking();
  window.addEventListener('scroll', updateCardStacking);
  
  // Add character counter for comment textareas
  document.querySelectorAll('.comment-input').forEach(textarea => {
    const jokeId = textarea.closest('.comment-form').querySelector('.comment-char-count').dataset.jokeId;
    const counter = document.querySelector(`.comment-char-count[data-joke-id="${jokeId}"]`);
    
    textarea.addEventListener('input', function() {
      const length = this.value.length;
      counter.textContent = `${length}/500`;
      
      if (length > 450) {
        counter.style.color = '#ff6b6b';
      } else if (length > 400) {
        counter.style.color = '#feca57';
      } else {
        counter.style.color = '#999';
      }
    });
  });
});

function updateCardStacking() {
  const cards = document.querySelectorAll('.joke-card');
  const scrollY = window.scrollY;
  const windowHeight = window.innerHeight;
  const viewportMiddle = scrollY + windowHeight / 2;
  
  cards.forEach((card, index) => {
    const cardRect = card.getBoundingClientRect();
    const cardTop = scrollY + cardRect.top;
    const cardBottom = cardTop + cardRect.height;
    const cardMiddle = cardTop + cardRect.height / 2;
    
    // Calculate distance from viewport middle
    const distanceFromMiddle = Math.abs(cardMiddle - viewportMiddle);
    
    // Calculate z-index based on position
    // Cards closer to middle get higher z-index
    const baseZIndex = 100;
    const zIndex = baseZIndex + cards.length - Math.floor(distanceFromMiddle / 50);
    card.style.zIndex = zIndex;
    
    // Add classes based on position relative to viewport middle
    card.classList.remove('in-view', 'above-view', 'below-view');
    
    if (cardMiddle < viewportMiddle - 100) {
      card.classList.add('above-view');
    } else if (cardMiddle > viewportMiddle + 100) {
      card.classList.add('below-view');
    } else {
      card.classList.add('in-view');
    }
    
    // Add slight rotation and translation for depth effect
    const rotation = (cardMiddle - viewportMiddle) / windowHeight * 3; // Max 3 degrees
    const translateY = (cardMiddle - viewportMiddle) / windowHeight * 10; // Max 10px
    
    if (!card.matches(':hover')) {
      card.style.transform = `translateY(${translateY}px) rotateX(${-rotation}deg) scale(${card.classList.contains('in-view') ? 1 : 0.97})`;
    }
  });
}
</script>
{% endblock %}
